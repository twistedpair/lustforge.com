<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>LogRotate Apache Logs to Amazon S3 &#183; </title><meta name=description content="
      Legacy Log Rotation before gzip & scp
    


I recently moved my site RunPartner to Amazon Web Services (AWS) from DreamHost because for just a few more peanuts a month I got a ton of enterprise grade services, and the server does not crash randomly any more. üòä
I‚Äôm loving AWS, but one thing I wanted to do was consolidate all logs to S3. Let‚Äôs say your site gets SlashDotted or Pinned. One of the first failure modes is that your logs swell up, and you‚Äôre out of disk space. Since my EC2 instance has just 8GB, this is possible. But why not use that infinite storage pool in the sky, S3? Perfect."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.140.2"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="LogRotate Apache Logs to Amazon S3"><meta property="og:description" content="
      Legacy Log Rotation before gzip & scp
    


I recently moved my site RunPartner to Amazon Web Services (AWS) from DreamHost because for just a few more peanuts a month I got a ton of enterprise grade services, and the server does not crash randomly any more. üòä
I‚Äôm loving AWS, but one thing I wanted to do was consolidate all logs to S3. Let‚Äôs say your site gets SlashDotted or Pinned. One of the first failure modes is that your logs swell up, and you‚Äôre out of disk space. Since my EC2 instance has just 8GB, this is possible. But why not use that infinite storage pool in the sky, S3? Perfect."><meta property="og:type" content="article"><meta property="og:url" content="https://lust.dev/2012/07/15/logrotate-apache-logs-to-amazon-s3/"><link rel=stylesheet href=https://lust.dev/dist/site.css><link rel=stylesheet href=https://lust.dev/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://lust.dev//css/font-awesome-all.min.css></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=G-W625CVG5Q9"></script><script>var dnt,doNotTrack=!1;if(!0&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W625CVG5Q9")}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml aria-label=RSS><i class="fa fa-rss" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Bluesky aria-label=bluesky href=https://bsky.app/profile/lust.dev rel=me><i class="fa-brands fa-bluesky" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/twistedpair rel=me><i class="fa-brands fa-github-alt" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust rel=me><i class="fa-brands fa-stack-overflow" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=LinkedIn aria-label=LinkedIn href=https://linkedin.com/in/josephlust rel=me><i class="fa-brands fa-linkedin" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=../../../../>Blog</a></li><li class=site-nav-item><a href=../../../../tags>Tags</a></li><li class=site-nav-item><a href=../../../../about>About J. Lust</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">LogRotate Apache Logs to Amazon S3</h1><p class=post-date><span>Published <time datetime=2012-07-15 itemprop=datePublished>15 Jul '12</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author>Joseph Lust</a></span></span></p><p class="post-reading post-line"><span>‚è∞ 4 min read</span></p></header><div class="post-content clearfix" itemprop=articleBody><figure><img src=../../../../img/logrotate.png><figcaption><h4>Legacy Log Rotation before gzip & scp</h4></figcaption></figure><p>I recently moved my site <a href=www.runpartner.com>RunPartner</a> to Amazon Web Services (AWS) from DreamHost because for just a few more peanuts a month I got a ton of enterprise grade services, and the server does not crash randomly any more. üòä</p><p>I‚Äôm loving AWS, but one thing I wanted to do was consolidate all logs to S3. Let‚Äôs say your site gets SlashDotted or Pinned. One of the first failure modes is that your logs swell up, and you‚Äôre out of disk space. Since my EC2 instance has just 8GB, this is possible. But why not use that infinite storage pool in the sky, S3? Perfect.</p><h2 id=logrotate>LogRotate</h2><p>A long time fixture of the log rotation scene is LogRotate, not to be confused with Apache‚Äôs RotateLogs. The following script works well for me (two years¬†and counting).</p><p>The script assumes you‚Äôve installed the amazing command line package, <a href=http://s3tools.org/s3cmd>s3cmd</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># rotate the logs!</span>
</span></span><span class=line><span class=cl><span class=c1># common settings</span>
</span></span><span class=line><span class=cl>compress
</span></span><span class=line><span class=cl>compresscmd /bin/gzip
</span></span><span class=line><span class=cl>compressoptions -9
</span></span><span class=line><span class=cl>compressext .gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dateext
</span></span><span class=line><span class=cl>dateformat -%Y-%m-%d-%s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rotate <span class=m>3</span>
</span></span><span class=line><span class=cl>nomail
</span></span><span class=line><span class=cl>missingok
</span></span><span class=line><span class=cl>daily
</span></span><span class=line><span class=cl>size 5k
</span></span><span class=line><span class=cl>create <span class=m>640</span> username username
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/var/logs/www.runpartner.com/*.log <span class=o>{</span>
</span></span><span class=line><span class=cl>sharedscripts
</span></span><span class=line><span class=cl>postrotate
</span></span><span class=line><span class=cl>sudo /usr/sbin/apache2ctl graceful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/usr/bin/s3cmd sync /var/logs/www.runpartner.com/*.gz s3://bucket-logs/www.runpartner.com/
</span></span><span class=line><span class=cl>endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=how-it-works>How It Works</h2><p>It took me a few hours to get everything tweaked just right, so I‚Äôll break down the commands for your edification and so that you can customize the script for yourself.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>compress
</span></span><span class=line><span class=cl>compresscmd /bin/gzip
</span></span><span class=line><span class=cl>compressoptions -9
</span></span><span class=line><span class=cl>compressext .gz
</span></span></code></pre></div><ul><li><code>compress</code> - enables compression</li><li><code>compresscmd</code> - determines the path to the utility used to compress</li><li><code>compressoptions</code> - command line switches passed to the compression utility</li><li><code>compressext</code> - this suffix will be used to determine if files have been compressed</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dateext
</span></span><span class=line><span class=cl>dateformat -%Y-%m-%d-%s
</span></span></code></pre></div><ul><li><code>dateext</code> - enables adding dates to the log file names</li><li><code>dateformat</code> - <code>%Y-%m-%d-%s</code> provides the format for the log file name dates</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rotate <span class=m>3</span>
</span></span><span class=line><span class=cl>nomail
</span></span><span class=line><span class=cl>missingok
</span></span><span class=line><span class=cl>daily
</span></span><span class=line><span class=cl>size 5k
</span></span><span class=line><span class=cl>create <span class=m>640</span> username username
</span></span></code></pre></div><ul><li><code>rotate 3</code> - how many logs to keep locally before deleting. The more, the more space used</li><li><code>nomail</code> - don‚Äôt try to mail the logs to any body</li><li><code>missingok</code> - tells script not to freak out that there are no files on first run</li><li><code>daily</code> - rollover logs on a daily basis (<strong>still must call from Cron though</strong>)</li><li><code>size 5K</code> - set minimum size of log rollover. If file is smaller than this, it will not be rolled.</li><li><code>create 640 username username</code> - add any permissions the files should be given on creation. I needed these, or the compression utility did not have the right to compress them.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/var/logs/www.runpartner.com/*.log <span class=o>{</span>
</span></span><span class=line><span class=cl>sharedscripts
</span></span><span class=line><span class=cl>postrotate
</span></span><span class=line><span class=cl>sudo /usr/sbin/apache2ctl graceful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/usr/bin/s3cmd sync /var/logs/www.runpartner.com/*.gz s3://bucket-logs/www.runpartner.com/
</span></span><span class=line><span class=cl>endscript
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><ul><li><code>/var/logs/www.runpartner.com/*.log</code> - file selector, can contain wildcards, or can be explicit</li><li><code>sharedscripts</code> - only run the code between <em>postrotate</em> & <em>endscript</em> <strong>once</strong>, even if multiple files rotated</li><li><code>postrotate...endscript</code> -code to send logs to S3<ul><li><code>sudo /usr/sbin/apache2ctl graceful</code> gracefully resets the logs on the apache server, otherwise logging stops because LogRotate removed the log file! Some people just kill the pid, but this is much cleaner.</li><li><code>/usr/bin/s3cmd sync /var/logs/www.runpartner.com/*.gz s3://bucket-logs/www.runpartner.com/</code> use s3cmd to sync your logs (not many of them, so goes fast) to your log bucket on S3.</li></ul></li></ul><h2 id=cron-it>Cron it</h2><p>Now just don‚Äôt forget the last step!!! You need to add your LogRotate command to cron, so it can run each day. If you have a lot of traffic, you might want to run it on the hour, with your <em>size</em> attribute set so that large logs get moved to S3 quickly, freeing up space on your instance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Backup activities</span>
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>0</span> * * * /usr/sbin/logrotate --state /home/username/scripts/log_rotate.state /home/username/scripts/log_rotate.config
</span></span></code></pre></div><p>Notice the below I run the rollover at midnight. This way all entries in the log for a given date are really for that date. Also,¬†<strong>don‚Äôt forget the state file</strong>. This is how LogRotate knows what it did last time, so it can decide what to do this time. Finally, notice that cron needs the full path to everything, including the¬†executables and the config/state files.</p></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=../../../../tags/amazon-ec2/>Amazon EC2</a>,
<a href=../../../../tags/amazon-s3/>Amazon S3</a>,
<a href=../../../../tags/aws/>AWS</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=LogRotate%20Apache%20Logs%20to%20Amazon%20S3&url=https%3a%2f%2flust.dev%2f2012%2f07%2f15%2flogrotate-apache-logs-to-amazon-s3%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' aria-label="Share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i>
</a><a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flust.dev%2f2012%2f07%2f15%2flogrotate-apache-logs-to-amazon-s3%2f" onclick='return window.open(this.href,"facebook-share","width=580,height=296"),!1' aria-label="Share on Facebook"><i class="fa fa-facebook" aria-hidden=true></i></a></div></footer><div class=comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//lustforge.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2024 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script><script src=https://lust.dev/js/jquery.fitvids.js></script><script src=https://lust.dev/js/scripts.js></script></body></html>