<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Upgrading to Google Cloud Functions 2nd Gen &#183; Joseph Lust</title><meta name=description content="Take the leap, upgrade to 2nd Gen Google Cloud Functions!"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Upgrading to Google Cloud Functions 2nd Gen"><meta property="og:description" content="Take the leap, upgrade to 2nd Gen Google Cloud Functions!"><meta property="og:type" content="article"><meta property="og:url" content="https://lust.dev/2022/08/04/upgrading-cloud-functions-gen2/"><link rel=stylesheet href=https://lust.dev/dist/site.css><link rel=stylesheet href=https://lust.dev/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><meta name=twitter:image content="/img/gcf_next_gen.png"><meta property="og:image" content="/img/gcf_next_gen.png"></head><body><script type=application/javascript>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-17498476-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml aria-label=RSS><i class="fa fa-rss" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Twitter aria-label=Twitter href=https://twitter.com/lustcoder rel=me><i class="fa fa-twitter" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/twistedpair rel=me><i class="fa fa-github-alt" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust rel=me><i class="fa fa-stack-overflow" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=LinkedIn aria-label=LinkedIn href=https://linkedin.com/in/josephlust rel=me><i class="fa fa-linkedin" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=../../../../>Blog</a></li><li class=site-nav-item><a href=../../../../tags>Tags</a></li><li class=site-nav-item><a href=../../../../page/about/>About J. Lust</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Upgrading to Google Cloud Functions 2nd Gen</h1><p class=post-date><span>Published <time datetime=2022-08-04 itemprop=datePublished>4 Aug '22</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author>Joe Lust</a></span></span></p><p class="post-reading post-line"><span>‚è∞ 7 min read</span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=../../../../img/gcf_next_gen.png><p>GCF 2nd gen is <a href=https://cloud.google.com/functions/docs/release-notes#August_03_2022>GA</a> this week üéâ. Let‚Äôs get you upgraded to the <a href=https://cloud.google.com/functions/docs/release-notes#August_03_2022>2nd gen Cloud Functions runtime</a>! What is this ‚Äú2nd gen‚Äù I speak of? It‚Äôs Cloud Functions, but running on <a href=https://cloud.google.com/run>Cloud Run</a>, behind the scenes, enabling many new features.</p><h1 id=compelling-reasons-to-upgrade>Compelling Reasons to Upgrade</h1><p>First, why should you upgrade? There are many benefits, including:</p><ul><li><strong>Timeout Length</strong> goes from 9min to 60min</li><li><strong>Memory</strong> goes from 8GiB to 16GiB</li><li><strong>CPU</strong> goes from 1 vCPU to 4 vCPUs</li><li><strong>Concurrency control:</strong> now one GCF instance may service multiple requests/events</li><li><strong>Traffic Splitting:</strong> now send X% of traffic to a given deployed version (impossible before)</li><li><strong>New Events:</strong> Trigger your function with over <a href=https://cloud.google.com/eventarc/docs/reference/supported-events>90 Eventarc event types</a> from GCP</li></ul><h1 id=lets-upgrade-on-to-2nd-gen>Let‚Äôs Upgrade. On, to 2nd Gen!</h1><p>Excellent choice. We‚Äôll need to make a few changes to your deployment scripts. Here‚Äôs what changed:</p><h2 id=stuff-thats-gone>Stuff that‚Äôs gone</h2><p><strong>Security Level</strong> is a GCF feature that lets an HTTP triggered function redirect HTTP requests to HTTPS (a.k.a. upgrade to TLS). By default, GCF will accept HTTP or HTTPS, but using HTTP is insecure, so this is a great feature.</p><p>If you use the <code>--security-level=secure-always</code> flag in gcloud, you‚Äôll need to remove it.</p><p>Don&rsquo;t worry, <code>secure-always</code> is the new default for 2nd Gen üîí. Three cheers for security!</p><h2 id=stuff-thats-added>Stuff that‚Äôs added</h2><p><strong>Gen2</strong> has a new flag. Add the <code>--gen2</code> flag when deploying a GCF, so it uses the 2nd gen runtime.</p><p><strong>Region</strong> is now required. GCF needs to know what region you‚Äôre deploying to, so pass the <code>--region</code> flag. This way you can deploy to <code>us-central1</code>, <code>us-west2</code>, etc (ProTip‚Ñ¢ checkout the <a href=https://cloud.withgoogle.com/region-picker>Region Picker Tool</a>).</p><p><strong>Run Service Account</strong> takes the place of <code>--service-account</code>. Use <code>--run-service-account</code> to pass the runtime service account you previously passed in 1st Gen.</p><p><strong>Artifact Registry</strong> now stores the compiled GCF output. Our container images will live here, so Cloud Run can access them. <a href=https://cloud.google.com/artifact-registry>Artifact Registry</a> is the new home of containers on GCP.</p><h3 id=stuff-that-might-break-whats-in-a-name>Stuff that might break: What‚Äôs in a name?</h3><h3 id=name-limits>Name Limits</h3><p>We said earlier that GCF 2nd Gen runs on Cloud Run, ‚Äúbehind the scenes‚Äù. Unfortunately, some of that Cloud Run magic leaks through the abstractions in 2nd Gen. Specifically, Cloud Functions names must now comply with <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-label-names>RFC 1123 naming conventions</a>.</p><p>Here are example names that you cannot use:</p><ul><li><code>myAwesomeFunction</code> - nope, has capital letters</li><li><code>1-fist-2-fish</code> - nah, cannot start with a number</li><li><code>convert-base64</code> - nada, cannot end with a number</li><li><code>snake_cased</code> - nyet, no underscores, only dashes (<code>-</code>)</li><li><code>google-cloud-function-that-does-amazing-stuff-with-cloud-capybara</code> - too long, must be ‚â§ 63 char</li></ul><p>This change is especially challenging for Java and similar languages that stardize on <a href=https://en.wikipedia.org/wiki/Camel_case>camelCase</a> function names.</p><h3 id=url-changes>URL Changes</h3><p>Now that we‚Äôre actually running in Cloud Run, the HTTP triggered function URLs will be of the format:</p><p><strong>1st Gen</strong>: <code>https://&lt;REGION_NAME>-&lt;PROJECT_NAME>.cloudfunctions.net/&lt;FUNCTION_NAME></code></p><p><strong>2nd Gen</strong>: <code>https://&lt;FUNCTION_NAME>-&lt;MAGIC_HASH_BYTES>-&lt;REGION_SHORT_CODE>.a.run.app</code></p><p>What‚Äôs the impact:
You‚Äôll need to update anything calling these URLs (e.g. webhooks calling your function). Any <a href=https://cloud.google.com/pubsub/docs/push>HTTP push Pub/Sub subscriptions</a> will need to be replaced with the proper 2nd Gen URL.</p><h1 id=full-beforeafter-example>Full before/after example</h1><p>Enough reading already, let‚Äôs deploy a 2nd Gen GCF! Let‚Äôs compare the following two deploys</p><h2 id=before-1st-gen-gcf-deploy>Before: 1st Gen GCF Deploy</h2><p>Here we&rsquo;ve got the simplest Hello World function you can make. Let&rsquo;s deploy it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>helloWorld</span> <span class=o>=</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>resp</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>resp</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>200</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Hi, brave world!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We&rsquo;ll use <code>gcloud</code> and the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud functions deploy helloWorld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --project lust-dev-demo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --trigger-http <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --allow-unauthenticated <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-account<span class=o>=</span>gcf-no-privilege@lust-dev-demo.iam.gserviceaccount.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --runtime<span class=o>=</span>nodejs16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --security-level<span class=o>=</span><span class=s2>&#34;secure-always&#34;</span>
</span></span></code></pre></div><p>The function can be reached at <code>https://us-central1-lust-dev-demo.cloudfunctions.net/helloWorld</code> (I&rsquo;ve since taken it down). We&rsquo;ll test it with <code>curl</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://us-central1-lust-dev-demo.cloudfunctions.net/helloWorld
</span></span></code></pre></div><blockquote><p>Hi, brave world!</p></blockquote><p>This took an average of 73s to deploy<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, since Cloud Build needs to make a container image behind the scenes. This isn&rsquo;t as fast as AWS Lambda&rsquo;s couple second deploy, but in a CI/CD pipeline, this difference is trivial (and the GCP interface and UX sure are better). Add to that the extra work Cloud Run is doing, giving us full blown containers and traffic splitting.</p><h2 id=after-2nd-gen-gcf-deploy>After: 2nd Gen GCF Deploy</h2><p>We&rsquo;ll need to make several changes. The effective command is below. We&rsquo;ll walk through how we arrived at it next.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud functions deploy hello <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --project lust-dev-demo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --trigger-http <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --allow-unauthenticated <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --run-service-account<span class=o>=</span>gcf-no-privilege@lust-dev-demo.iam.gserviceaccount.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --runtime<span class=o>=</span>nodejs16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --gen2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --region<span class=o>=</span>us-central1
</span></span></code></pre></div><p>Let&rsquo;s try deploying to 2nd Gen. Oh no, we got an error message:</p><blockquote><p>API [artifactregistry.googleapis.com] not enabled on project [lust-dev-demo]. Would you like to enable and retry (this will take a few minutes)? (y/N)?</p></blockquote><p>GCP is nudging us to use <a href=https://cloud.google.com/artifact-registry>Artifact Registry</a> (with <a href=https://cloud.google.com/blog/products/application-development/understanding-artifact-registry-vs-container-registry>many new features</a>), rather than the older <a href=https://cloud.google.com/container-registry>Container Registry</a> (GCR). Let&rsquo;s enable that API.</p><blockquote><p>ERROR: (gcloud.functions.deploy) INVALID_ARGUMENT: Could not create Cloud Run service helloWorld. metadata.name: Resource name must use only lowercase letters, numbers and &lsquo;-&rsquo;. Must begin with a letter and cannot end with a &lsquo;-&rsquo;. Maximum length is 63 characters.</p></blockquote><p>Darn, we got another error. <code>helloWorld</code> is an invalid name in Kubernetes land. We&rsquo;ll need to rename to <code>hello-world</code> (remember, <code>hello_world</code> is no bueno too). Let&rsquo;s try again.</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=7, message=Cloud Functions uses Artifact Registry to store function docker images. Artifact Registry API is not enabled in your project. To enable the API, visit <a href=https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com>https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com</a> or use the gcloud command &lsquo;gcloud services enable artifactregistry.googleapis.com&rsquo;.</p></blockquote><p>Darn. gcloud just told me that the API is enabled&mldr; but seems we&rsquo;re still not enabled. Better head to the GCP web console to see what this fuss is about.</p><p><a href=../../../../img/artifact_registry_enabled.png><figure><img src=../../../../img/artifact_registry_enabled.png></figure></a></p><p>Interesting, web console (pictured) says it is enabled. This must be one of those <a href=https://en.wikipedia.org/wiki/Eventual_consistency>eventually consitent</a> parts of GCP. Let&rsquo;s give it a moment and try again.</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=3, message=Could not create or update Cloud Run service hello-world, Container Healthcheck failed. Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. Logs for this revision might contain more information.</p></blockquote><p>OK, we&rsquo;re getting closer. Why didn&rsquo;t our function &ldquo;start&rdquo; and listen? Geeze, the fact we&rsquo;re running on Cloud Run really is leaking through now. Let&rsquo;s check those linked Cloud Build logs:</p><blockquote><p>Function &lsquo;hello-world&rsquo; is not defined in the provided module.
Did you specify the correct target function to execute?</p></blockquote><p>üí°We need to change our entry point. GCF is looking for a function named <code>hello-world</code>, but our Javascript method is named <code>helloWorld</code>. Maybe we can use the <code>--entry-point=helloWorld</code> argument to override this? ü§û One more time!</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=3, message=Could not create or update Cloud Run service hello-world, Container Healthcheck failed. Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. Logs for this revision might contain more information.</p></blockquote><p>OK. Seems this doesn&rsquo;t work. Same error. Note: we cannot name the Javascript function <code>hello-world</code> because that&rsquo;s not a valid Javascript function name ü§¶. üí°üí°Final idea, just call this thing <code>hello</code> in the deployment command and in the Javascript. Here we go, pray for Mojo.</p><blockquote><p>Preparing function&mldr;done.<br>‚úì Deploying function&mldr;<br>‚úì [Build] Logs are available at [https://console.cloud.google.com/cloud-build/builds;region=us-central1/d0066814-1c90-4af0-909b-4c81bb832bdf?project=344128826
217]<br>‚úì [Service]<br>. [ArtifactRegistry]<br>. [Healthcheck]<br>. [Triggercheck]<br>Done.</p></blockquote><p>We made it! <strong>Welcome to 2nd Gen!</strong> üéâ And checkout those faster deploy times<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Only 55s.</p><p>Note that now the URL to test is <code>https://hello-qfttn6wsxq-uc.a.run.app</code>. This is very different from the old GCF URL. You&rsquo;ll need to update anything that points to this, meaning you cannot move from 1st Gen to 2nd Gen while &ldquo;online&rdquo; and serving traffic. You&rsquo;ll need to cut over and rewire Pub/Sub subscriptions, webhooks, <a href=https://cloud.google.com/scheduler/docs/creating>Cloud Scheduler HTTP triggers</a>, etc.</p><p>Here&rsquo;s the difference in commands, visually:</p><p><a href=../../../../img/command_compare.png><figure><img src=../../../../img/command_compare.png></figure></a></p><h1 id=conclusions>Conclusions</h1><ul><li>Cloud Functions 2nd Gen offers many improvements over 1st Gen</li><li>2nd Gen deploys ~25% faster than 1st Gen (non-scientic analysis)</li><li>Make sure you&rsquo;re running on Artifact Registry before moving to 2nd Gen</li><li>Be prepared to rename your functions in both code and deployment tooling</li><li>Be prepared to update everything that points HTTP functions as the URLs will change</li></ul><p>Finally, if cutting over existing code to 2nd Gen, I&rsquo;d suggesting keeping up the 1st Gen functions, and deploying the 2nd Gen functions beside them in parallel. Once the 2nd Gen functions are clearly up and running well, take down the legacy 1st Gen deployments. Enjoy!</p><p>Story image backdrop courtesy of <a href=https://unsplash.com/@kellysikkema>Kelly Sikkema</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>1st Gen sample deploys 1:23/1:01/1:10&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>2nd Gen sample deploys 0:55/0:55/0:55/0:55 (very consistent!)&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=../../../../tags/cloud-functions/>cloud-functions</a>,
<a href=../../../../tags/cloud-run/>cloud-run</a>,
<a href=../../../../tags/serverless/>serverless</a>,
<a href=../../../../tags/google-cloud-platform/>google-cloud-platform</a>,
<a href=../../../../tags/cloud/>cloud</a>,
<a href=../../../../tags/upgrade/>upgrade</a>,
<a href=../../../../tags/gco/>gco</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Upgrading%20to%20Google%20Cloud%20Functions%202nd%20Gen&url=https%3a%2f%2flust.dev%2f2022%2f08%2f04%2fupgrading-cloud-functions-gen2%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' aria-label="Share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flust.dev%2f2022%2f08%2f04%2fupgrading-cloud-functions-gen2%2f" onclick='return window.open(this.href,"facebook-share","width=580,height=296"),!1' aria-label="Share on Facebook"><i class="fa fa-facebook" aria-hidden=true></i></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//lustforge.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2022 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script>
<script src=https://lust.dev/js/jquery.fitvids.js></script>
<script src=https://lust.dev/js/scripts.js></script></body></html>