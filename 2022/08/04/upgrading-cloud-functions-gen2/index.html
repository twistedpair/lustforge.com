<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Upgrading to Google Cloud Functions Gen2 &#183; Joseph Lust</title><meta name=description content="a cloud engineering blog"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://lust.dev/favicon.png><link rel=stylesheet href=https://lust.dev/css/normalize.css><link rel=stylesheet href=https://lust.dev/css/highlight/obsidian.css><link rel=stylesheet href=https://lust.dev/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css></head><body><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-17498476-1","auto"),ga("send","pageview"))</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml><i title="RSS Feed" class="fa fa-rss"></i></a>
<a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/lustcoder><i class="fa fa-twitter"></i></a>
<a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/twistedpair><i class="fa fa-github-alt"></i></a>
<a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust><i class="fa fa-stack-overflow"></i></a>
<a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/josephlust><i class="fa fa-linkedin"></i></a><h1 class=site-title style=margin-left:10px><a class=site-title data-hint=Lust title="Meet the groundskeeper" href=https://lust.dev/about/>J. Lust &#8250;</a></h1></div><ul class=site-nav></ul></div></header><div id=container><div class=container><article class=post-container><header class=post-header><h1 class=post-title>Upgrading to Google Cloud Functions Gen2</h1></header><div class="post-content clearfix"><div itemscope itemtype=http://schema.org/BlogPosting style=display:none><meta itemprop=mainEntityOfPage content="https://lust.dev/2022/08/04/upgrading-cloud-functions-gen2/"><meta itemprop=inLanguage content="en-US"><h1 itemprop=headline>Upgrading to Google Cloud Functions Gen2</h1><meta itemprop=name content="Upgrading to Google Cloud Functions Gen2"><meta itemprop=description content="Take the leap, upgreade your Google Cloud Functions to the Gen2 runtime!"><meta itemprop=wordCount content="1320"><meta itemprop=keywords content="cloud-functions,cloud-run,google-cloud-platform,cloud,gen2,gen1,upgrade"><meta itemprop=copyrightYear content="2022"><div itemprop=copyrightHolder itemscope itemtype=http://schema.org/Person><meta itemprop=name content="Joseph Lust"></div><div itemprop=image itemscope itemtype=http://schema.org/ImageObject><img itemprop=url src=https://lust.dev/img/gcf_next_gen.jpeg alt=thumbnail><meta itemprop=width content="220"><meta itemprop=height content="220"></div><meta itemprop=datePublished content="2022-08-04"><meta itemprop=dateModified content="2022-08-04"><a itemprop=mainEntityOfPage href=../../../../ArticleLink></a><div itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content="Joseph Lust"></div><div itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="lust.dev"><a itemprop=url href=../../../../><span itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img itemprop=image src=https://lust.dev/favicon.png>
<link itemprop=url href=https://lust.dev/favicon.png></span></a></div></div><img class=post-featured-image src=../../../../img/gcf_next_gen.jpeg><p>GCF Gen2<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> is <a href=https://cloud.google.com/functions/docs/release-notes#August_03_2022>GA</a> this week üéâ. Let‚Äôs get you upgraded to the <a href=https://cloud.google.com/functions/docs/release-notes#August_03_2022>Gen2 Cloud Functions runtime</a>! What is this ‚ÄúGen2‚Äù I speak of? It‚Äôs Cloud Functions, but running on <a href=https://cloud.google.com/run>Cloud Run</a>, behind the scenes, enabling many new features.</p><h1 id=compelling-reasons-to-upgrade>Compelling Reasons to Upgrade</h1><p>First, why should you upgrade? There are many benefits, including:</p><ul><li><strong>Timeout Length</strong> goes from 9min to 60min</li><li><strong>Memory</strong> goes from 8GiB to 16GiB</li><li><strong>CPU</strong> goes from 1 vCPU to 4 vCPUs</li><li><strong>Concurrency control:</strong> now one GCF instance may service multiple requests/events</li><li><strong>Traffic Splitting:</strong> now send X% of traffic to a given deployed version (impossible before)</li><li><strong>New Events:</strong> Trigger your function with over <a href=https://cloud.google.com/eventarc/docs/reference/supported-events>90 Eventarc event types</a> from GCP</li></ul><h1 id=lets-upgrade-on-to-gen2>Let‚Äôs Upgrade. On, to Gen2!</h1><p>Excellent choice. We‚Äôll need to make a few changes to your deployment scripts. Here‚Äôs what changed:</p><h2 id=stuff-thats-gone>Stuff that‚Äôs gone</h2><p><strong>Security Level</strong> is a GCF feature that lets an HTTP triggered function redirect HTTP requests to HTTPS (a.k.a. upgrade to TLS). By default, GCF will accept HTTP or HTTPS, but using HTTP is insecure, so this is a great feature.</p><p>If you use the <code>--security-level=secure-always</code> flag in gcloud, you‚Äôll need to remove it.</p><p>Don&rsquo;t worry, <code>secure-always</code> is the new default for Gen2 üîí. Three cheers for security!</p><h2 id=stuff-thats-added>Stuff that‚Äôs added</h2><p><strong>Gen2</strong> has a new flag. Add the <code>--gen2</code> flag when deploying a GCF, so it uses the Gen2 runtime.</p><p><strong>Region</strong> is now required. GCF needs to know what region you‚Äôre deploying to, so pass the <code>--region</code> flag. This way you can deploy to <code>us-central1</code>, <code>us-west2</code>, etc (ProTip‚Ñ¢ checkout the <a href=https://cloud.withgoogle.com/region-picker>Region Picker Tool</a>).</p><p><strong>Run Service Account</strong> takes the place of <code>--service-account</code>. Use <code>--run-service-account</code> to pass the runtime service account you previously passed in Gen1.</p><p><strong>Artifact Registry</strong> now stores the compiled GCF output. Our container images will live here, so Cloud Run can access them. <a href=https://cloud.google.com/artifact-registry>Artifact Registry</a> is the new home of containers on GCP.</p><h3 id=stuff-that-might-break-whats-in-a-name>Stuff that might break: What‚Äôs in a name?</h3><h3 id=name-limits>Name Limits</h3><p>We said earlier that GCF Gen2 runs on Cloud Run, ‚Äúbehind the scenes‚Äù. Unfortunately, some of that Cloud Run magic leaks through the abstractions in Gen2. Specifically, Cloud Functions names must now comply with <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-label-names>RFC 1123 naming conventions</a>.</p><p>Here are example names that you cannot use:</p><ul><li><code>myAwesomeFunction</code> - nope, has capital letters</li><li><code>1-fist-2-fish-red-fish-blue_-ish</code> - nah, cannot start with a number</li><li><code>convert-base64</code> - nada, cannot end with a number</li><li><code>snake_caser</code> - nyet, no underscores, only dashes (<code>-</code>)</li><li><code>google-cloud-function-that-does-amazing-stuff-with-cloud-capybara</code> - too long, must be ‚â§ 63 char</li></ul><p>This change is especially challenging for Java and similar languages that stardize on <a href=https://en.wikipedia.org/wiki/Camel_case>camelCase</a> function names.</p><h3 id=url-changes>URL Changes</h3><p>Now that we‚Äôre actually running in Cloud Run, the HTTP triggered function URLs will be of the format:</p><p><strong>Gen1</strong>: <code>https://&lt;REGION_NAME>-&lt;PROJECT_NAME>.cloudfunctions.net/&lt;FUNCTION_NAME></code></p><p><strong>Gen2</strong>: <code>https://&lt;FUNCTION_NAME>-&lt;MAGIC_HASH_BYTES>-&lt;REGION_SHORT_CODE>.a.run.app</code></p><p>What‚Äôs the impact:
You‚Äôll need to update anything calling these URLs (e.g. webhooks calling your function). Any <a href=https://cloud.google.com/pubsub/docs/push>HTTP push Pub/Sub subscriptions</a> will need to be replaced with the proper Gen2 URL.</p><h1 id=full-beforeafter-example>Full before/after example</h1><p>Enough reading already, let‚Äôs deploy a Gen2 GCF! Let‚Äôs compare the following two deploys</p><h2 id=before-gen1-gcf-deploy>Before: Gen1 GCF Deploy</h2><p>Here we&rsquo;ve got the simplest Hello World function you can make. Let&rsquo;s deploy it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>helloWorld</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>resp</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Hi, brave world!&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We&rsquo;ll use <code>gcloud</code> and the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud functions deploy helloWorld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --project lust-dev-demo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --trigger-http <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --allow-unauthenticated <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --service-account<span style=color:#f92672>=</span>gcf-no-privilege@lust-dev-demo.iam.gserviceaccount.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --runtime<span style=color:#f92672>=</span>nodejs16 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --security-level<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;secure-always&#34;</span>
</span></span></code></pre></div><p>The function can be reached at <code>https://us-central1-lust-dev-demo.cloudfunctions.net/helloWorld</code> (I&rsquo;ve since taken it down). We&rsquo;ll test it with <code>curl</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://us-central1-lust-dev-demo.cloudfunctions.net/helloWorld
</span></span></code></pre></div><blockquote><p>Hi, brave world!</p></blockquote><p>This took an average of 73s to deploy<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, since Cloud Build needs to make a container image behind the scenes. This isn&rsquo;t as fast as AWS Lambda&rsquo;s 1s deploy, but in a CI/CD pipeline, this difference is trivial (and the GCP interface and UX sure are better).</p><h2 id=after-gen2-gcf-deploy>After: Gen2 GCF Deploy</h2><p>We&rsquo;ll need to make several changes. The effective command is below. We&rsquo;ll walk through how we arrived at it next.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud functions deploy hello <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --project lust-dev-demo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --trigger-http <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --allow-unauthenticated <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --run-service-account<span style=color:#f92672>=</span>gcf-no-privilege@lust-dev-demo.iam.gserviceaccount.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --runtime<span style=color:#f92672>=</span>nodejs16 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --gen2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --region<span style=color:#f92672>=</span>us-central1
</span></span></code></pre></div><p>Let&rsquo;s try deploying to Gen2. Oh no, we got an error message:</p><blockquote><p>API [artifactregistry.googleapis.com] not enabled on project [lust-dev-demo]. Would you like to enable and retry (this will take a few minutes)? (y/N)?</p></blockquote><p>GCP is nudging us to use <a href=https://cloud.google.com/artifact-registry>Artifact Registry</a> (with <a href=https://cloud.google.com/blog/products/application-development/understanding-artifact-registry-vs-container-registry>many new features</a>), rather than the older <a href=https://cloud.google.com/container-registry>Container Registry</a> (GCR). Let&rsquo;s enable that API.</p><blockquote><p>ERROR: (gcloud.functions.deploy) INVALID_ARGUMENT: Could not create Cloud Run service helloWorld. metadata.name: Resource name must use only lowercase letters, numbers and &lsquo;-&rsquo;. Must begin with a letter and cannot end with a &lsquo;-&rsquo;. Maximum length is 63 characters.</p></blockquote><p>Darn, we got another error. <code>helloWorld</code> is an invalid name in Kubernetes land. We&rsquo;ll need to rename to <code>hello-world</code> (remember, <code>hello_world</code> is no bueno too). Let&rsquo;s try again.</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=7, message=Cloud Functions uses Artifact Registry to store function docker images. Artifact Registry API is not enabled in your project. To enable the API, visit <a href=https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com>https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com</a> or use the gcloud command &lsquo;gcloud services enable artifactregistry.googleapis.com&rsquo;.</p></blockquote><p>Darn. gcloud just told me that the API is enabled&mldr; but seems we&rsquo;re still not enabled. Better head to the GCP web console to see what this fuss is about.</p><p><a href=../../../../img/artifact_registry_enabled.png><figure><img src=../../../../img/artifact_registry_enabled.png></figure></a></p><p>Interesting, web console (pictured) says it is enabled. This must be one of those <a href=https://en.wikipedia.org/wiki/Eventual_consistency>eventually consitent</a> parts of GCP. Let&rsquo;s give it a moment and try again.</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=3, message=Could not create or update Cloud Run service hello-world, Container Healthcheck failed. Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. Logs for this revision might contain more information.</p></blockquote><p>OK, we&rsquo;re getting closer. Why didn&rsquo;t our function &ldquo;start&rdquo; and listen? Geeze, the fact we&rsquo;re running on Cloud Run really is leaking through now. Let&rsquo;s check those linked Cloud Build logs:</p><blockquote><p>Function &lsquo;hello-world&rsquo; is not defined in the provided module.
Did you specify the correct target function to execute?</p></blockquote><p>üí°We need to change our entry point. GCF is looking for a function named <code>hello-world</code>, but our Javascript method is named <code>helloWorld</code>. Maybe we can use the <code>--entry-point=helloWorld</code> argument to override this? ü§û One more time!</p><blockquote><p>ERROR: (gcloud.functions.deploy) OperationError: code=3, message=Could not create or update Cloud Run service hello-world, Container Healthcheck failed. Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. Logs for this revision might contain more information.</p></blockquote><p>OK. Seems this doesn&rsquo;t work. Same error. Note: we cannot name the Javascript function <code>hello-world</code> because that&rsquo;s not a valid Javascript function name ü§¶. üí°üí°Final idea, just call this thing <code>hello</code> in the deployment command and in the Javascript. Here we go, pray for Mojo.</p><blockquote><p>Preparing function&mldr;done.<br>‚úì Deploying function&mldr;<br>‚úì [Build] Logs are available at [https://console.cloud.google.com/cloud-build/builds;region=us-central1/d0066814-1c90-4af0-909b-4c81bb832bdf?project=344128826
217]<br>‚úì [Service]<br>. [ArtifactRegistry]<br>. [Healthcheck]<br>. [Triggercheck]<br>Done.</p></blockquote><p>We made it! <strong>Welcome to Gen2!</strong> üéâ And checkout those faster deploy times<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. Only 55s.</p><p>Note that now the URL to test is <code>https://hello-qfttn6wsxq-uc.a.run.app</code>. This is very different from the old GCF URL. You&rsquo;ll need to update anything that points to this, meaning you cannot move from Gen1 to Gen2 while &ldquo;online&rdquo; and serving traffic. You&rsquo;ll need to cut over and rewire Pub/Sub subscriptions, webhooks, <a href=https://cloud.google.com/scheduler/docs/creating>Cloud Scheduler HTTP triggers</a>, etc.</p><p>Here&rsquo;s the difference in commands, visually:</p><p><a href=../../../../img/command_compare.png><figure><img src=../../../../img/command_compare.png></figure></a></p><h1 id=conclusions>Conclusions</h1><ul><li>Cloud Functions Gen2 offers many improvements over Gen1</li><li>Gen2 deploys ~25% faster than Gen1 (non-scientic analysis)</li><li>Make sure you&rsquo;re running on Artifact Registry before moving to Gen2</li><li>Be prepared to rename your functions in both code and deployment tooling</li><li>Be prepared to update everything that points HTTP functions as the URLs will change</li></ul><p>Finally, if cutting over existing code to Gen2, I&rsquo;d suggesting keeping up the Gen1 functions, and deploying the Gen2 functions beside them in parallel. Once the Gen2 functions are clearly up and running well, take down the legacy Gen1 deployments. Enjoy!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>GCF documentation now uses &ldquo;1st Gen&rdquo; and &ldquo;2nd Gen&rdquo;, but I use &ldquo;gen2&rdquo; here since that&rsquo;s what gcloud uses. Plus, it just sounds better.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Gen1 sample deploys 1:23/1:01/1:10&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Gen2 sample deploys 0:55/0:55/0:55 (very consistent!)&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2009 - 2022 / Powered by <a href=http://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/twistedpair/ghostwriter>Lustwriter theme</a> By J. Lust</span>
<span>/ Forked from <a href=https://github.com/jbub/ghostwriter>Ghostwriter</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script>
<script src=https://lust.dev/js/jquery.fitvids.js></script>
<script src=https://lust.dev/js/scripts.js></script></body></html>