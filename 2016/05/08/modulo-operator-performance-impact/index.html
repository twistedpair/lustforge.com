<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Modulo Operator Performance Impact &#183; </title><meta name=description content="My textbooks used modulo, yet my boss told me not to. Where had I gone wrong?"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.140.2"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Modulo Operator Performance Impact"><meta property="og:description" content="My textbooks used modulo, yet my boss told me not to. Where had I gone wrong?"><meta property="og:type" content="article"><meta property="og:url" content="https://lust.dev/2016/05/08/modulo-operator-performance-impact/"><link rel=stylesheet href=https://lust.dev/dist/site.css><link rel=stylesheet href=https://lust.dev/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://lust.dev//css/font-awesome-all.min.css></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=G-W625CVG5Q9"></script><script>var dnt,doNotTrack=!1;if(!0&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W625CVG5Q9")}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml aria-label=RSS><i class="fa fa-rss" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Bluesky aria-label=bluesky href=https://bsky.app/profile/lust.dev rel=me><i class="fa-brands fa-bluesky" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/twistedpair rel=me><i class="fa-brands fa-github-alt" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust rel=me><i class="fa-brands fa-stack-overflow" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=LinkedIn aria-label=LinkedIn href=https://linkedin.com/in/josephlust rel=me><i class="fa-brands fa-linkedin" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=../../../../>Blog</a></li><li class=site-nav-item><a href=../../../../tags>Tags</a></li><li class=site-nav-item><a href=../../../../about>About J. Lust</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Modulo Operator Performance Impact</h1><p class=post-date><span>Published <time datetime=2016-05-08 itemprop=datePublished>8 May '16</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author>Joseph Lust</a></span></span></p><p class="post-reading post-line"><span>‚è∞ 3 min read</span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=../../../../img/modulo_benchmark_chart.png><p>I was surprised when someone told me not to use the <a href=https://en.wikipedia.org/wiki/Modulo_operation>modulo operator</a> in high performance code. My textbooks used modulo (<code>%</code>) and various high performance implementations <a href=https://dzone.com/articles/hashmap-performance>say to use modulo</a>. Where had I gone wrong?</p><h2 id=the-bad>The Bad</h2><p>If you look at the JDK&rsquo;s <code>mod()</code> implementation, you&rsquo;ll see that it&rsquo;s indeed <code>O(n)</code> <a href=https://github.com/openjdk-mirror/jdk7u-jdk/blob/f4d80957e89a19a29bb9f9807d2a28351ed7f7df/src/share/native/java/lang/fdlibm/src/e_fmod.c#L42>for IEE754 floats</a>, and <code>O(1)</code> <a href=https://github.com/openjdk-mirror/jdk7u-jdk/blob/f4d80957e89a19a29bb9f9807d2a28351ed7f7df/src/share/native/java/lang/fdlibm/src/s_modf.c#L46>for doubles</a>. Note, the Java Spec defines modulo for integers and also <a href=https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.17.3>for negative floating point numbers</a>.</p><p>Luckily, there are tricks for modulo with integers.</p><h2 id=high-performance-modulo>High Performance Modulo</h2><p>Here&rsquo;s the trick; <strong>don&rsquo;t use floats</strong>. Floats are a pain for numerous reason, but let&rsquo;s assume you&rsquo;re wise enough to use a primitive integer type (int or long) to feed you <code>mod()</code> code, such as your hashmap implementation. There are many neat <a href=http://graphics.stanford.edu/~seander/bithacks.html#ModulusDivisionEasy>bit twiddling tricks</a> to quickly conjure <code>mod(int,int)</code>.</p><h3 id=powers-of-two>Powers of Two</h3><p>Computers are binary by nature, so using powers of two provide lots of tricks. These can compute <code>mod(int, somePowerOf2)</code> in only a <em>single machine instruction</em>! Here&rsquo;s how.</p><p>For example, if I want to do <code>61 % 8</code>, to know which of an <code>Array[Byte]</code> to grab a value from, we can think of it in binary as <a href=https://en.wikipedia.org/wiki/Logical_conjunction>logical conjunction</a> of the dividend with the mask of all bits lower than the divisor. For powers of 2, that&rsquo;s just n-1. The bit operations are illustrated below, using 32 bit integers.</p><p><a href=../../../../img/bit_diagram.svg><figure><img src=../../../../img/bit_diagram.svg alt="Note: Applicable only to Natural Integers"><figcaption><p>Note: Applicable only to Natural Integers</p></figcaption></figure></a></p><p>We can code this simply as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>modPow2</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span> <span class=n>p2</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span> <span class=k>=</span> <span class=n>n</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>p2</span><span class=o>-</span><span class=mi>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>isPow2</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Boolean</span> <span class=o>=</span> <span class=o>((</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>n</span> <span class=o>)</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>modFast</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span> <span class=n>b</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span> <span class=k>=</span> <span class=k>if</span> <span class=o>(</span><span class=n>isPow2</span><span class=o>(</span><span class=n>b</span><span class=o>))</span> <span class=n>modPow2</span><span class=o>(</span><span class=n>n</span><span class=o>,</span><span class=n>b</span><span class=o>)</span> <span class=k>else</span> <span class=n>n</span> <span class=o>%</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The old way
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>def</span> <span class=n>modOld</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span> <span class=n>b</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span> <span class=k>=</span> <span class=n>n</span> <span class=o>%</span> <span class=n>b</span>
</span></span></code></pre></div><h2 id=performance-comparsion>Performance Comparsion</h2><p>Comparing the byte code of classic modulo, and our faster version, we see they are both <strong>4 lines of byte code</strong>. However, classic <code>%</code> calls the byte code operation <a href=https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.irem><code>irem</code></a> which itself calls a native routine, so it&rsquo;s far more complicated and won&rsquo;t run in constant time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>modOld</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>iload_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>iload_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>irem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>ireturn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>modPow2</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=p>);</span><span class=w> </span><span class=c1>// with 8-1 inlined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>iload_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>bipush</span><span class=w>        </span><span class=n>7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>iand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=n>ireturn</span><span class=w>
</span></span></span></code></pre></div><p>A simple benchmark<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> on bare metal<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> shows what we expect, doing one billion passes of each.</p><ul><li>Power 8 trick is the fastest</li><li><code>irem</code> implementation is nearly as fast</li><li><code>fmod</code> implementation is 3x slower</li></ul><p><a href=../../../../img/modulo_benchmark_chart.svg><figure><img src=../../../../img/modulo_benchmark_chart.svg></figure></a></p><h2 id=conclusions>Conclusions</h2><ul><li>Modulo isn&rsquo;t a major performance hog</li><li>Avoid Double modulo operations if possible (can you use int&rsquo;s?)</li><li>The reference Java modulo implementation is fast</li><li>For <code>mod(a,2^n)</code> operations, <code>modPow2</code> is ~23% faster than stock moduolo</li></ul><p>If modulo is a critical path in your code, and your divisor is a power of 2 (with Natural dividends), use this trick. Otherwise, the stock JVM implementation should serve you well.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Benchmarked with a <a href=https://gist.github.com/twistedpair/58414ee3237544eaf54a787a59f656c6>simple iterator</a>, and <a href=https://scalameter.github.io/>ScalaMeter</a>, and <a href=http://openjdk.java.net/projects/code-tools/jmh/>JMH</a> (see <a href=https://github.com/twistedpair/benchmark-jvm-modulo>repo</a>). JMH provided the most consistent approach, and uses the most advanced methods to warmup and prevent garbage collections. Performed on an untilized, bare metal machine with N=1 billion (1K runs of 1M iterations). JVM memory preallocated at startup (<code>-Xmx=2G -Xms=2G</code>)&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>HotSpot 1.8.0_91, Ubuntu 15.04, i7-4790K, 32GB PC3 19200 ram, SSD&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=../../../../tags/math/>Math</a>,
<a href=../../../../tags/performance/>Performance</a>,
<a href=../../../../tags/scala/>Scala</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Modulo%20Operator%20Performance%20Impact&url=https%3a%2f%2flust.dev%2f2016%2f05%2f08%2fmodulo-operator-performance-impact%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' aria-label="Share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i>
</a><a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flust.dev%2f2016%2f05%2f08%2fmodulo-operator-performance-impact%2f" onclick='return window.open(this.href,"facebook-share","width=580,height=296"),!1' aria-label="Share on Facebook"><i class="fa fa-facebook" aria-hidden=true></i></a></div></footer><div class=comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//lustforge.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2024 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script><script src=https://lust.dev/js/jquery.fitvids.js></script><script src=https://lust.dev/js/scripts.js></script></body></html>