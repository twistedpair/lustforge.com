<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Dangers of the Unit Type Parameter &#183;</title><meta name=description content="Confusing misuses of Unit and the loss of type checking."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.152.2"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Dangers of the Unit Type Parameter"><meta property="og:description" content="Confusing misuses of Unit and the loss of type checking."><meta property="og:type" content="article"><meta property="og:url" content="https://lust.dev/2016/04/12/dangers-of-unit-type-parameter/"><link rel=stylesheet href=https://lust.dev/dist/site.css><link rel=stylesheet href=https://lust.dev/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://lust.dev//css/font-awesome-all.min.css></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=G-W625CVG5Q9"></script><script>var dnt,doNotTrack=!1;if(!0&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W625CVG5Q9")}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml aria-label=RSS><i class="fa fa-rss" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Bluesky aria-label=bluesky href=https://bsky.app/profile/lust.dev rel=me><i class="fa-brands fa-bluesky" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/twistedpair rel=me><i class="fa-brands fa-github-alt" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust rel=me><i class="fa-brands fa-stack-overflow" aria-hidden=true></i>
</a><a class="button-square button-social hint--top" data-hint=LinkedIn aria-label=LinkedIn href=https://linkedin.com/in/josephlust rel=me><i class="fa-brands fa-linkedin" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=../../../../>Blog</a></li><li class=site-nav-item><a href=../../../../gcloud>gcloud</a></li><li class=site-nav-item><a href=../../../../tags>Tags</a></li><li class=site-nav-item><a href=../../../../about>About J. Lust</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Dangers of the Unit Type Parameter</h1><p class=post-date><span>Published <time datetime=2016-04-12 itemprop=datePublished>12 Apr '16</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author>Joseph Lust</a></span></span></p><p class="post-reading post-line"><span>‚è∞ 4 min read</span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=../../../../img/anti-unit.png><p>I ran into the following Scala pitfall when refactoring some code recently.</p><h2 id=the-problem>The problem</h2><p><a href=http://docs.scala-lang.org/overviews/core/futures.html#futures>Futures</a> sometimes execute in expected order, other times not. Testing with <code>Await.result(f)</code> didn&rsquo;t block. The world was no longer deterministic. Why? Unit.</p><h2 id=the-code>The code</h2><p>This was the code before:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>makeFut1</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>Int</span><span class=o>]</span> <span class=k>=</span> <span class=nc>Future</span><span class=o>.</span><span class=n>successful</span><span class=o>(</span> <span class=mi>1</span> <span class=o>+</span> <span class=mi>1</span><span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>makeFut2</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=nc>Future</span><span class=o>.</span><span class=n>successful</span><span class=o>(</span> <span class=s>&#34;foo&#34;</span> <span class=o>+</span> <span class=s>&#34;bar&#34;</span> <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>doSideEffect</span><span class=o>(</span><span class=n>a</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span><span class=n>b</span><span class=k>:</span><span class=kt>String</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=n>println</span><span class=o>(</span><span class=s>s&#34;[</span><span class=si>$a</span><span class=s>] [</span><span class=si>$b</span><span class=s>]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>doWork</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>Unit</span><span class=o>]</span> <span class=k>=</span> 
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>futA</span> <span class=k>&lt;-</span> <span class=n>makeFut1</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=n>futB</span> <span class=k>&lt;-</span> <span class=n>makeFut2</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> <span class=k>yield</span> <span class=n>doSideEffect</span><span class=o>(</span><span class=n>futA</span><span class=o>,</span><span class=n>futB</span><span class=o>)</span>
</span></span></code></pre></div><p>Alas synchronous <code>doSideEffect(...)</code> method was refactored to be async, becoming:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>doSideEffect</span><span class=o>(</span><span class=n>a</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span><span class=n>b</span><span class=k>:</span><span class=kt>String</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=nc>Future</span> <span class=o>{</span> <span class=n>println</span><span class=o>(</span><span class=s>s&#34;[</span><span class=si>$a</span><span class=s>] [</span><span class=si>$b</span><span class=s>]&#34;</span><span class=o>)</span> <span class=o>}</span>
</span></span></code></pre></div><p>What broke? Nothing. Scala compiled and ran it just fine. But, WFT? We&rsquo;re yielding a <code>Future[Unit]</code> not a <code>Unit</code>, shouldn&rsquo;t that make <code>doWork()</code> return a <code>Future[Future[Unit]]</code> and fail type checking?</p><h2 id=unit-and-value-discarding>Unit and Value Discarding</h2><p>In short, the <a href=http://www.scala-lang.org/docu/files/ScalaReference.pdf>Scala Spec</a> section 6.26.1 says,</p><blockquote><p>If e has some value type and the expected type is Unit, e is converted
to the expected type by embedding it in the term { e; () }.</p></blockquote><p>The following code would be transformed accordingly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>intUnit</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span>        <span class=c1>// pre-compile
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>def</span> <span class=n>intUnit</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span><span class=n>n</span><span class=o>*</span><span class=mi>2</span><span class=o>;</span> <span class=o>()}</span>  <span class=c1>// post-compile
</span></span></span></code></pre></div><p>This gets tricky with type parameters. If you returned <code>Future[Future[Unit]]</code>, you&rsquo;re really returning <code>Future[Unit]</code>.</p><h2 id=compiler-dont-care-bout-unit>Compiler Don&rsquo;t Care `bout Unit</h2><p>Thus, we see that by returning the Unit type, we&rsquo;re really returning Void, and lose any type checking of the return type at all. As such, the compiler doesn&rsquo;t give a damn<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> what we return. Any <code>Future</code> executed in said yield will probably be invoked, but not as this flatmapping chain of futures, and not in the order you&rsquo;d expect.</p><p><code>doSideEffect(...)</code> is invoked, and it&rsquo;s Future created, but said Future isn&rsquo;t tied to this sequence of Futures. Thus, the Future returned by <code>doWork()</code> won&rsquo;t wait for it, returning <code>Unit</code> immeadiately.</p><h2 id=dont-return-unit>Don&rsquo;t Return Unit</h2><p>Only use return type Unit for Void functions (a.k.a. Procedures). Using Unit to parameterize a type effectively negates type checking on that type, and loses the guarantees you&rsquo;ve come to expect from the type system and compiler.</p><p>An alternative to the above example, using a sealed algebra for return state, would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>sealed</span> <span class=k>trait</span> <span class=nc>Result</span>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>Good</span> <span class=k>extends</span> <span class=nc>Result</span>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>Bad</span> <span class=k>extends</span> <span class=nc>Result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>makeFut1</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>Int</span><span class=o>]</span> <span class=k>=</span> <span class=nc>Future</span><span class=o>.</span><span class=n>successful</span><span class=o>(</span> <span class=mi>1</span> <span class=o>+</span> <span class=mi>1</span><span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>makeFut2</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=nc>Future</span><span class=o>.</span><span class=n>successful</span><span class=o>(</span> <span class=s>&#34;foo&#34;</span> <span class=o>+</span> <span class=s>&#34;bar&#34;</span> <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>doSideEffectB</span><span class=o>(</span><span class=n>a</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span><span class=n>b</span><span class=k>:</span><span class=kt>String</span><span class=o>)</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>Result</span><span class=o>]</span> 
</span></span><span class=line><span class=cl>  <span class=k>=</span> <span class=nc>Future</span> <span class=o>{</span> <span class=n>println</span><span class=o>(</span><span class=s>s&#34;[</span><span class=si>$a</span><span class=s>] [</span><span class=si>$b</span><span class=s>]&#34;</span><span class=o>);</span> <span class=nc>Good</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>doWork</span><span class=o>()</span><span class=k>:</span><span class=kt>Future</span><span class=o>[</span><span class=kt>Result</span><span class=o>]</span> <span class=k>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>futA</span> <span class=k>&lt;-</span> <span class=n>makeFut1</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=n>futB</span> <span class=k>&lt;-</span> <span class=n>makeFut2</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>yield</span> <span class=n>doSideEffectB</span><span class=o>(</span><span class=n>futA</span><span class=o>,</span><span class=n>futB</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>And failed to compile, as we&rsquo;d hope!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Sample.scala:55: error: <span class=nb>type</span> mismatch<span class=p>;</span>
</span></span><span class=line><span class=cl> found   : scala.concurrent.Future<span class=o>[</span>Result<span class=o>]</span>
</span></span><span class=line><span class=cl> required: Result
</span></span><span class=line><span class=cl>        <span class=o>}</span> yield doSideEffectB<span class=o>(</span>futA,futB<span class=o>)</span>
</span></span><span class=line><span class=cl>                             ^
</span></span><span class=line><span class=cl>one error found
</span></span></code></pre></div><p>Horay for types!</p><h2 id=appendix-unit-type-and-void>(Appendix) Unit Type and Void</h2><p><a href=http://www.scala-lang.org/files/archive/nightly/docs/library/index.html#scala.Unit$>Unit</a> is a <a href=https://en.wikipedia.org/wiki/Unit_type>Unit Type</a> from Type Theory, meaning it&rsquo;s a universal singleton instance referenced by <code>()</code>, the zero tuple. Every <code>()</code> in your code points to the same Unit instance. Since all Scala value types can be converted to Unit, the compiler may change them to Unit as required for return signatures to match. Any <em>value type</em><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> can be converted.</p><p>Let&rsquo;s decompile the following functions to see what Scala does to Unit returns:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>intInt</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Int</span> <span class=o>=</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>intUnit</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>intInt</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>iconst_2</span><span class=w> </span><span class=c1>// Load integer 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>iload_1</span><span class=w>  </span><span class=c1>// Load another int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>imul</span><span class=w>     </span><span class=c1>// Multiply ints </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>ireturn</span><span class=w>  </span><span class=c1>// return product</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>intUnit</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Code</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>0</span><span class=p>:</span><span class=w> </span><span class=n>iconst_2</span><span class=w> </span><span class=c1>// Load integer 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>1</span><span class=p>:</span><span class=w> </span><span class=n>iload_1</span><span class=w>  </span><span class=c1>// Load another int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>2</span><span class=p>:</span><span class=w> </span><span class=n>imul</span><span class=w>     </span><span class=c1>// Multiply ints </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>3</span><span class=p>:</span><span class=w> </span><span class=n>pop</span><span class=w>      </span><span class=c1>// Discard value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>4</span><span class=p>:</span><span class=w> </span><span class=k>return</span><span class=w>   </span><span class=c1>// Return VOID</span><span class=w>
</span></span></span></code></pre></div><p>The <a href=https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings>byte code</a> shows Java does the math in both cases, but the Unit return <strong>discards all values and returns Void.</strong></p><h2 id=appendix-incorrect-unit-use>(Appendix) Incorrect Unit Use</h2><p>Because Unit is converted from any other <em>value type</em>, <code>Unit</code> can be converted to <code>()</code>. That is, Unit can be converted from a type to an instance by the complier, sort of. This can lead to confusion in code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>myProcedure</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span><span class=n>n</span> <span class=o>*</span> <span class=n>n</span><span class=o>;</span> <span class=nc>Unit</span><span class=o>}</span>      <span class=c1>// pre-compiled
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>def</span> <span class=n>myProcedure</span><span class=o>(</span><span class=n>n</span><span class=k>:</span><span class=kt>Int</span><span class=o>)</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span><span class=n>n</span> <span class=o>*</span> <span class=n>n</span><span class=o>;</span> <span class=nc>Unit</span><span class=o>;</span> <span class=o>()}</span>  <span class=c1>// post-compiled
</span></span></span></code></pre></div><p>Developers may explicitly return <code>Unit</code>, but really they are returning the <em>Unit type</em>, not the singleton Unit reference, <code>()</code>. The reference to the actual type is being discarded.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Set the <code>-Ywarn-value-discard</code> compiler flag to fail builds on Value Discarding&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>value type T , <code>scala.Nothing &lt;: T &lt;: scala.Any</code>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=../../../../tags/futures/>Futures</a>,
<a href=../../../../tags/scala/>Scala</a></p></footer><div class=comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://lust.dev/2016/04/12/dangers-of-unit-type-parameter/",this.page.identifier="/2016/04/12/dangers-of-unit-type-parameter/"};(function(){var e=document,t=e.createElement("script");t.src="https://lustforge.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2025 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script><script src=https://lust.dev/js/jquery.fitvids.js></script><script src=https://lust.dev/js/scripts.js></script></body></html>