<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Modulo Operator Performance Impact &middot; Joseph Lust</title><meta name=description content="drive to develop"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.59.1"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://lust.dev/favicon.png><link rel=stylesheet href=https://lust.dev/css/normalize.css><link rel=stylesheet href=https://lust.dev/css/highlight/obsidian.css><link rel=stylesheet href=https://lust.dev/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css><meta property="og:type" content="article"><meta property="og:url" content="https://lust.dev/2016/05/08/modulo-operator-performance-impact/"><meta property="og:title" content="Modulo Operator Performance Impact"><meta name=twitter:domain value=lustforge.com><meta name=twitter:card content="summary_large_image"><meta name=twitter:title value="Modulo Operator Performance Impact"><meta name=twitter:description value="My textbooks used modulo, yet my boss told me not to. Where had I gone wrong?"><meta name=twitter:url value=https://lust.dev/2016/05/08/modulo-operator-performance-impact/><meta property="og:image" content="https://lust.dev/img/modulo_benchmark_chart.png"><meta property="twitter:image" content="https://lust.dev/img/modulo_benchmark_chart.png"></head><body><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-17498476-1','auto');ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml><i title="RSS Feed" class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/lustcoder><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/twistedpair><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust><i class="fa fa-stack-overflow"></i></a><a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/josephlust><i class="fa fa-linkedin"></i></a><h1 class=site-title style=margin-left:10px><a class=site-title data-hint=Lust title="Meet the groundskeeper" href=https://lust.dev/about/>J. Lust &#8250;</a></h1></div><ul class=site-nav></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Modulo Operator Performance Impact</h1><p class=post-date><span>Published <time datetime=2016-05-08 itemprop=datePublished>Sun, May 8, 2016</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=http://schema.org/Person><span itemprop=name><a href=https://stackoverflow.com/users/564157/joseph-lust itemprop=url rel=author>Joseph Lust</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=../../../../img/modulo_benchmark_chart.png><p>I was surprised when someone told me not to use the <a href=https://en.wikipedia.org/wiki/Modulo_operation>modulo operator</a> in high performance code. My textbooks used modulo (<code>%</code>) and various high performance implementations <a href=https://dzone.com/articles/hashmap-performance>say to use modulo</a>. Where had I gone wrong?</p><h2 id=the-bad>The Bad</h2><p>If you look at the JDK&rsquo;s <code>mod()</code> implementation, you&rsquo;ll see that it&rsquo;s indeed <code>O(n)</code> <a href=https://github.com/openjdk-mirror/jdk7u-jdk/blob/f4d80957e89a19a29bb9f9807d2a28351ed7f7df/src/share/native/java/lang/fdlibm/src/e_fmod.c#L42>for IEE754 floats</a>, and <code>O(1)</code> <a href=https://github.com/openjdk-mirror/jdk7u-jdk/blob/f4d80957e89a19a29bb9f9807d2a28351ed7f7df/src/share/native/java/lang/fdlibm/src/s_modf.c#L46>for doubles</a>. Note, the Java Spec defines modulo for integers and also <a href=https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.17.3>for negative floating point numbers</a>.</p><p>Luckily, there are tricks for modulo with integers.</p><h2 id=high-performance-modulo>High Performance Modulo</h2><p>Here&rsquo;s the trick; <strong>don&rsquo;t use floats</strong>. Floats are a pain for numerous reason, but let&rsquo;s assume you&rsquo;re wise enough to use a primitive integer type (int or long) to feed you <code>mod()</code> code, such as your hashmap implementation. There are many neat <a href=http://graphics.stanford.edu/~seander/bithacks.html#ModulusDivisionEasy>bit twiddling tricks</a> to quickly conjure <code>mod(int,int)</code>.</p><h3 id=powers-of-two>Powers of Two</h3><p>Computers are binary by nature, so using powers of two provide lots of tricks. These can compute <code>mod(int, somePowerOf2)</code> in only a <em>single machine instruction</em>! Here&rsquo;s how.</p><p>For example, if I want to do <code>61 % 8</code>, to know which of an <code>Array[Byte]</code> to grab a value from, we can think of it in binary as <a href=https://en.wikipedia.org/wiki/Logical_conjunction>logical conjunction</a> of the dividend with the mask of all bits lower than the divisor. For powers of 2, that&rsquo;s just n-1. The bit operations are illustrated below, using 32 bit integers.</p><p><a href=../../../../img/bit_diagram.svg><figure><img src=../../../../img/bit_diagram.svg alt="Note: Applicable only to Natural Integers"><figcaption><p>Note: Applicable only to Natural Integers</p></figcaption></figure></a></p><p>We can code this simply as:</p><pre><code class=language-scala>def modPow2(n:Int, p2: Int) = n &amp; (p2-1)

def isPow2(n:Int):Boolean = ((n-1) &amp; n ) == 0

def modFast(n:Int, b: Int) = if (isPow2(b)) modPow2(n,b) else n % b

// The old way
def modOld(n:Int, b:Int) = n % b
</code></pre><h2 id=performance-comparsion>Performance Comparsion</h2><p>Comparing the byte code of classic modulo, and our faster version, we see they are both <strong>4 lines of byte code</strong>. However, classic <code>%</code> calls the byte code operation <a href=https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.irem><code>irem</code></a> which itself calls a native routine, so it&rsquo;s far more complicated and won&rsquo;t run in constant time.</p><pre><code class=language-java>  public int modOld(int, int);
    Code:
       0: iload_1
       1: iload_2
       2: irem
       3: ireturn

  public int modPow2(int, int); // with 8-1 inlined
    Code:
       0: iload_1
       1: bipush        7
       3: iand
       4: ireturn
</code></pre><p>A simple benchmark<sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup> on bare metal<sup class=footnote-ref id=fnref:2><a href=#fn:2>2</a></sup> shows what we expect, doing one billion passes of each.</p><ul><li>Power 8 trick is the fastest</li><li><code>irem</code> implementation is nearly as fast</li><li><code>fmod</code> implementation is 3x slower</li></ul><p><a href=../../../../img/modulo_benchmark_chart.svg><figure><img src=../../../../img/modulo_benchmark_chart.svg></figure></a></p><h2 id=conclusions>Conclusions</h2><ul><li>Modulo isn&rsquo;t a major performance hog</li><li>Avoid Double modulo operations if possible (can you use int&rsquo;s?)</li><li>The reference Java modulo implementation is fast</li><li>For <code>mod(a,2^n)</code> operations, <code>modPow2</code> is ~23% faster than stock moduolo</li></ul><p>If modulo is a critical path in your code, and your divisor is a power of 2 (with Natural dividends), use this trick. Otherwise, the stock JVM implementation should serve you well.</p><div class=footnotes><hr><ol><li id=fn:1>Benchmarked with a <a href=https://gist.github.com/twistedpair/58414ee3237544eaf54a787a59f656c6>simple iterator</a>, and <a href=https://scalameter.github.io/>ScalaMeter</a>, and <a href=http://openjdk.java.net/projects/code-tools/jmh/>JMH</a> (see <a href=https://github.com/twistedpair/benchmark-jvm-modulo>repo</a>). JMH provided the most consistent approach, and uses the most advanced methods to warmup and prevent garbage collections. Performed on an untilized, bare metal machine with N=1 billion (1K runs of 1M iterations). JVM memory preallocated at startup (<code>-Xmx=2G -Xms=2G</code>)
<a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li><li id=fn:2>HotSpot 1.8.0_91, Ubuntu 15.04, i7-4790K, 32GB PC3 19200 ram, SSD
<a class=footnote-return href=#fnref:2><sup>[return]</sup></a></li></ol></div></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=../../../../tags/math/>Math</a>
<a href=../../../../tags/performance/>Performance</a>
<a href=../../../../tags/scala/>Scala</a>
<a href=../../../../tags/>[all]</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Modulo%20Operator%20Performance%20Impact&url=https%3a%2f%2flust.dev%2f2016%2f05%2f08%2fmodulo-operator-performance-impact%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flust.dev%2f2016%2f05%2f08%2fmodulo-operator-performance-impact%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a>
<a class=icon-google-plus href="https://plus.google.com/share?url=https%3a%2f%2flust.dev%2f2016%2f05%2f08%2fmodulo-operator-performance-impact%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i><span class=hidden>Google+</span></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lustforge"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2009 - 2018 / Powered by <a href=http://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/twistedpair/ghostwriter>Lustwriter theme</a> By J. Lust</span>
<span>/ Forked from <a href=https://github.com/jbub/ghostwriter>Ghostwriter</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script src=https://lust.dev/js/jquery.fitvids.js></script><script src=https://lust.dev/js/scripts.js></script></body></html>