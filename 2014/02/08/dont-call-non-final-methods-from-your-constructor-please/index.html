<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Don’t call non-final methods from your constructor, please. &#183; Joseph Lust</title><meta name=description content="a cloud engineering blog"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://lust.dev/favicon.png><link rel=stylesheet href=https://lust.dev/css/normalize.css><link rel=stylesheet href=https://lust.dev/css/highlight/obsidian.css><link rel=stylesheet href=https://lust.dev/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css></head><body><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-17498476-1","auto"),ga("send","pageview"))</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class=button-square href=https://lust.dev/index.xml><i title="RSS Feed" class="fa fa-rss"></i></a>
<a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/lustcoder><i class="fa fa-twitter"></i></a>
<a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/twistedpair><i class="fa fa-github-alt"></i></a>
<a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/564157/joseph-lust><i class="fa fa-stack-overflow"></i></a>
<a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/josephlust><i class="fa fa-linkedin"></i></a><h1 class=site-title style=margin-left:10px><a class=site-title data-hint=Lust title="Meet the groundskeeper" href=https://lust.dev/about/>J. Lust &#8250;</a></h1></div><ul class=site-nav></ul></div></header><div id=container><div class=container><article class=post-container><header class=post-header><h1 class=post-title>Don’t call non-final methods from your constructor, please.</h1></header><div class="post-content clearfix"><div itemscope itemtype=http://schema.org/BlogPosting style=display:none><meta itemprop=mainEntityOfPage content="https://lust.dev/2014/02/08/dont-call-non-final-methods-from-your-constructor-please/"><meta itemprop=inLanguage content="en-US"><h1 itemprop=headline>Don’t call non-final methods from your constructor, please.</h1><meta itemprop=name content="Don’t call non-final methods from your constructor, please."><meta itemprop=description content><meta itemprop=wordCount content="500"><meta itemprop=keywords content="Java"><meta itemprop=copyrightYear content="2014"><div itemprop=copyrightHolder itemscope itemtype=http://schema.org/Person><meta itemprop=name content="Joseph Lust"></div><div itemprop=image itemscope itemtype=http://schema.org/ImageObject><img itemprop=url src=https://lust.dev/img/lustforge_key_default.png alt=thumbnail><meta itemprop=width content="200"><meta itemprop=height content="200"></div><meta itemprop=datePublished content="2014-02-08"><meta itemprop=dateModified content="2014-02-08"><a itemprop=mainEntityOfPage href=../../../../ArticleLink></a><div itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content="Joseph Lust"></div><div itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="lust.dev"><a itemprop=url href=../../../../><span itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img itemprop=image src=https://lust.dev/favicon.png>
<link itemprop=url href=https://lust.dev/favicon.png></span></a></div></div><p>I ran into problems with someone doing this recently, so I’ll have to embellish the web a little more. The world must learn.</p><p>Why don’t we call non-final methods from constructors? Because it’s bad. Why is it bad? Because OO has an order to the madness and this ain’t the order. Let’s do a quick experiment to find out why.</p><p>Here is our parent and child class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FooKlassParent</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Parent: Init static block 1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SysWriter w1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysWriter<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Parent: non-static field init&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> SysWriter w2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysWriter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Parent: static field init&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>FooKlassParent</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Parent: Constructor called&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        doSomething<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Parent: Init static block 2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doSomething</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Parent: do something&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>log</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String msg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>So many goodies! Static blocks, static fields, non-static fields, non-static methods. Yum. If you’re programming Java and don’t know the order these all fire in, please switch to PHP.</p><p>Now we’ll extend with a child who is essentially the same.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FooKlass</span> <span style=color:#66d9ef>extends</span> FooKlassParent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Child: Init static block 1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SysWriter w1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysWriter<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Child: non-static field init&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> SysWriter w2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SysWriter<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Child: static field init&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>FooKlass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Child: Constructor called&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        doSomething<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Child: Init static block 2&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doSomething</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// shame, you didn&#39;t call super.doSomething() first!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        log<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Child: do something&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Ok, now everyone pick up your pencils and write what will be the output of making a new FooKlass.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Parent: Init static block <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Parent: static field init
</span></span><span style=display:flex><span>Parent: Init static block <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>Child: Init static block <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Child: static field init
</span></span><span style=display:flex><span>Child: Init static block <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>Parent: non-static field init
</span></span><span style=display:flex><span>Parent: Constructor called
</span></span><span style=display:flex><span>Child: <span style=color:#66d9ef>do</span> something
</span></span><span style=display:flex><span>Child: non-static field init
</span></span><span style=display:flex><span>Child: Constructor called
</span></span><span style=display:flex><span>Child: <span style=color:#66d9ef>do</span> something
</span></span></code></pre></div><p>Alright, so what did we learn? Things don’t “just happen” – Java operates by the JSR which is painfully specific here. The firing order is:</p><ol><li>Parent static blocks and fields in order of appearance</li><li>Child static blocks and fields in order of appearance</li><li>Parent non-static field initializers</li><li>Parent constructor</li><li>Child non-static field initializers</li><li>Child constructor</li></ol><p>Damn! That’s mind blowing! The child’s constructor calls <strong>super()</strong> but super() was really called before the child’s constructor. WYSINWYG. The byte code ain’t the code you wrote folks.</p><p>Now, to conclude, why are non-final method invocations from the constructor bad? The child class’s fields are not initialized yet. It’s state is not yet prepared. Even though we see the parent’s method, it’s been overwritten with the child’s byte code. <strong>Unholy things can happen now because your assumptions are no longer valid</strong>. And worse, it’s not just your assumptions, but someone might extend that lib/API class non-final public method. Mayhem will ensue, at 3AM, on Christmas Eve, when you’re on the support rotation and as you rub your eyes and stare into the debugger it just ain’t going to make sense to you.</p><p>Don’t do it.</p></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=lust.dev href=https://lust.dev/>lust.dev</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2009 - 2022 / Powered by <a href=http://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/twistedpair/ghostwriter>Lustwriter theme</a> By J. Lust</span>
<span>/ Forked from <a href=https://github.com/jbub/ghostwriter>Ghostwriter</a></span></p></div></footer><script src=https://lust.dev/js/jquery-1.11.3.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script>
<script src=https://lust.dev/js/jquery.fitvids.js></script>
<script src=https://lust.dev/js/scripts.js></script></body></html>